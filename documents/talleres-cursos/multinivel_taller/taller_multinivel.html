<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>taller-multinivel-2021</title>
    <meta charset="utf-8" />
    <meta name="author" content=".small[Juan Carlos Castillo    Departamento de Sociología - UCH / COES   ]" />
    <script src="libs/header-attrs-2.3/header-attrs.js"></script>
    <link href="libs/tile-view-0.2.3/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view-0.2.3/tile-view.js"></script>
    <link href="libs/animate.css-3.7.2/animate.xaringan.css" rel="stylesheet" />
    <script src="libs/clipboard-2.0.6/clipboard.min.js"></script>
    <link href="libs/shareon-1.4.1/shareon.min.css" rel="stylesheet" />
    <script src="libs/shareon-1.4.1/shareon.min.js"></script>
    <link href="libs/xaringanExtra-shareagain-0.2.3/shareagain.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-shareagain-0.2.3/shareagain.js"></script>
    <link rel="stylesheet" href="custom_2020.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">

class: inverse bottom right













&lt;!---
Para correr en ATOM
- open terminal, abrir R (simplemente, R y enter)
- rmarkdown::render('static/docpres/07_interacciones/7interacciones.Rmd', 'xaringan::moon_reader')

About macros.js: permite escalar las imágenes como [scale 50%](path to image), hay si que grabar ese archivo js en el directorio.
---&gt;

![:scale 20%](https://multinivel.netlify.com/../images/hex_eic2.png)

# Taller estimación multinivel

Juan Carlos Castillo - [jc-castillo.com](http://jc-castillo.com/)

Enero 2021

---
class: roja, bottom, right

# El problema

---
# Preguntas

- ¿Se pueden sacar conclusiones sobre .blue[individuos] basados en datos de .red[contextos]?

  - ej: comunas más pobres tienen menor tasa de votación, por lo tanto ... personas pobres votan menos?
  
- ¿Se pueden hacer conclusiones sobre .red[contextos] basados en datos de .blue[individuos]?

  - ej: individuos más pobres votan menos, por lo tanto ... comunas  pobres votan menos (en promedio)?
  
---
# Falacia ecológica / individualista
![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/fal5.png)

---
# Contexto e implicancias teóricas

En el planteamiento de una investigación con hipótesis multinivel, es
relevante definir:

-   Qué es el **contexto**

--

-   Cuáles son los .blue[elementos principales] del contexto a considerar en las hipótesis

--

-   Cómo se relacionan variables del contexto con variables .red[individuales] 

---
## Tipos generales de problemas multinivel

Tres tipos de preguntas básicas, ejemplo educación:

--

1.  ¿Existen diferencias de rendimiento académico de los alumnos entre escuelas?

--

2.  ¿Tienen estas diferencias relación con variables de la escuela?

--

3.  Las características de los estudiantes, ¿poseen un efecto distinto en rendimiento de acuerdo a características de las escuelas?

---
class: roja bottom center

# Lógica de estimación


---
# Formas de estimación multinivel

Base: modelo de regresión simple (no multinivel)

![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/mod1.png)


---
# Formas de estimación multinivel

Modelo multinivel con predictores individuales, ajustado por pertenencia a unidades de nivel 2

![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/mod2.png)

---
# Formas de estimación multinivel

Modelo multinivel con predictores contextuales

![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/mod3.png)

---
# Formas de estimación multinivel

Modelo multinivel con predictores individuales y contextuales

![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/mod4.png)

---
# Formas de estimación multinivel

Modelo multinivel con interacción entre niveles

![:scale 60%](https://multinivel.netlify.app/docpres/02_bases/images/mod5.png)

---
# Elementos de la estimación multinivel

1.  Correlación intra clase

2.  Estimación con predictores nivel 1 (ajustando por anidación)

3.  (múltiples) predictores nivel 2

4.  Variabilidad de parámetros de estimación nivel 1 (pendientes)

5.  Interacción entre niveles


---
class: roja bottom right

# Residuos, dependencia y parámetros


---
## Residuos y dependencia contextual

![:scale 50%](https://multinivel.netlify.app/docpres/02_bases/images/res_mul4.png)

---
# Implicancias para el modelo de regresión:

-   Dependencia conextual de los residuos

-   Estimación descompone la varianza de los residuos *entre* y
*dentro* los grupos= en distintos niveles = **multinivel**.

-   En concreto, se agrega un término de error adicional al modelo:
`\(\mu_{0j}\)`

-   Este término de error se expresa como un **efecto aleatorio** (como opuesto a *efecto fijo*)

---
## Parámetros 

![:scale 90%](https://multinivel.netlify.app/docpres/02_bases/images/paramet.JPG)

---
# Detalles de la notación formal:
.medium[
-   `\(_i\)` es el índice asociado a los individuos
-   `\(_j\)` es el índice asociado a la pertenencia a grupos ( `\(_j=1 ..., N\)`)
-   `\(y_{ij}\)` es la variable dependiente
-   `\(X_{i}\)` es la variable independiente de nivel individual
-   `\(\beta\)` y `\(\gamma\)` son coeficientes de regresión
-   `\(Z_j\)` es la variable independiente a nivel grupal
-   `\(r_{ij}\)` es el residuo a nivel individual
-   `\(\mu_{j}\)` es un residuo/desviación de nivel grupal
-   `\(\tau_{00}\)` es la varianza de `\(\mu_{0j}\)`
-   `\(\sigma^2\)` es la varianza de `\(r_{ij}\)`
]

---
class: roja bottom right

# Práctica A: datos agregados y correlación intra-clase

---
## Práctica: High School &amp; Beyond (HSB) data

-   Level 2 variables:

  -   size (matricula)
  -   sector (1 = Catholic, 0 = public)
  -   pracad (proportion of students in the academic track)
  -   disclim (a scale measuring disciplinary climate)
  -   himnty (1 = more than 40% minority enrollment, 0 = less than 40%)
  -   meanses (mean of the SES values for the students in this school who are included in the level-1 file)

-  **Cluster variable**= id (school id)

---
### Librerías

```r
pacman::p_load(
haven,  # lectura de datos formato externo
car, # varias funciones, ej scatterplot
dplyr, # varios gestión de datos
stargazer, # tablas
corrplot, # correlaciones
ggplot2, # gráficos
lme4) # multilevel
```

---
## Datos
.medium[

```r
mlm &lt;-read_dta("http://www.stata-press.com/data/mlmus3/hsb.dta")
```
]

.medium[

```r
dim(mlm)
```

```
## [1] 7185   26
```
]

---
## Seleccionar variables de interés
.medium[

```r
names(mlm)
```

```
##  [1] "minority" "female"   "ses"      "mathach"  "size"     "sector"  
##  [7] "pracad"   "disclim"  "himinty"  "schoolid" "mean"     "sd"      
## [13] "sdalt"    "junk"     "sdalt2"   "num"      "se"       "sealt"   
## [19] "sealt2"   "t2"       "t2alt"    "pickone"  "mmses"    "mnses"   
## [25] "xb"       "resid"
```

```r
mlm=mlm %&gt;% select(minority,female,ses,mathach,size,
  sector,mnses,schoolid) %&gt;% as.data.frame()
```
]
---
## Descriptivos generales

.small[

```r
stargazer(as.data.frame(mlm),
          title = "Descriptivos generales", type='text')
```

```
## 
## Descriptivos generales
## ===================================================================
## Statistic   N     Mean    St. Dev.   Min   Pctl(25) Pctl(75)  Max  
## -------------------------------------------------------------------
## minority  7,185   0.275     0.446     0       0        1       1   
## female    7,185   0.528     0.499     0       0        1       1   
## ses       7,185  0.0001     0.779   -3.758  -0.538   0.602   2.692 
## mathach   7,185  12.748     6.878   -2.832  7.275    18.317  24.993
## size      7,185 1,056.862  604.172   100     565     1,436   2,713 
## sector    7,185   0.493     0.500     0       0        1       1   
## mnses     7,185  0.0001     0.414   -1.194  -0.323   0.327   0.825 
## schoolid  7,185 5,277.898 2,499.578 1,224   3,020    7,342   9,586 
## -------------------------------------------------------------------
```
]

---
## Descriptivos generales


```r
hist(mlm$mathach, xlim = c(0,30))
```

![](taller_multinivel_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;

---
## Descriptivos generales

.medium[

```r
scatterplot(mlm$mathach ~ mlm$ses,
  data=mlm, xlab="SES", ylab="Math Score",
  main="Math on SES", smooth=FALSE)
```

![](taller_multinivel_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;
]

---
## Descriptivos generales


```r
corrplot.mixed(cormat)
```

![](taller_multinivel_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;


---
# Datos anidados / con estructura jerárquica

&lt;br&gt;

| IDi | IDg | var_i1 | var_i2 | var_g1 | var_g2 |
|-----|-----|--------|--------|--------|--------|
| 1   | 1   | 8      | 7      | 4      | 1      |
| 2   | 1   | 5      | 5      | 4      | 1      |
| 3   | 1   | 3      | 1      | 4      | 1      |
| 4   | 2   | 3      | 2      | 6      | 8      |
| 5   | 2   | 1      | 4      | 6      | 8      |
| 6   | 2   | 7      | 5      | 6      | 8      |


---
## Datos agregados

- Datos nivel 2:

  - propios/idiosincráticos (ej: tamaño)
  - agregados: generados a partir de datos nivel 1

- Ejemplo:
  - nivel socioeconómico individual
  - nivel socioeconómico de la escuela ("agregado" del individual)

---
## Datos agregados

- Usando la funcion `group_by` (agrupar por) de la librería `dplyr`
- Se agrupa por la variable **cluster**, que identifica a las unidades de nivel 2 (en este caso, `schoolid`)
- Por defecto se hace con el promedio, pero se pueden hacer otras funciones como contar, porcentajes, mediana, etc.


```r
agg_mlm=mlm %&gt;% group_by(schoolid) %&gt;%
  summarise_all(funs(mean)) %&gt;% as.data.frame()
```

---
## Datos agregados - Descriptivos

.small[

```r
stargazer(agg_mlm, type = "text")
```

```
## 
## =================================================================
## Statistic  N    Mean    St. Dev.   Min   Pctl(25) Pctl(75)  Max  
## -----------------------------------------------------------------
## schoolid  160 5,309.994 2,547.683 1,224  3,018.2  7,431.8  9,586 
## minority  160   0.275     0.301   0.000   0.037    0.404   1.000 
## female    160   0.519     0.256   0.000   0.437    0.605   1.000 
## ses       160  -0.006     0.414   -1.194  -0.307   0.314   0.825 
## mathach   160  12.621     3.118   4.240   10.474   14.648  19.719
## size      160 1,097.825  629.506   100    588.5    1,526   2,713 
## sector    160   0.438     0.498     0       0        1       1   
## mnses     160  -0.006     0.414   -1.194  -0.307   0.314   0.825 
## -----------------------------------------------------------------
```
]

---
## Comparación Modelos

.small[
- Modelo con datos individuales


```r
reg&lt;- lm(mathach~ses+female+sector, data=mlm)
```

- Modelo con datos agregados


```r
reg_agg&lt;- lm(mathach~ses+female+sector, data=agg_mlm)
```

- Generación tabla


```r
stargazer(reg,reg_agg,
  column.labels=c("Individual","Agregado"),
  type ='text')
```
]
---
.small[

```
## 
## ======================================================================
##                                    Dependent variable:                
##                     --------------------------------------------------
##                                          mathach                      
##                            Individual                 Agregado        
##                                (1)                      (2)           
## ----------------------------------------------------------------------
## ses                         2.884***                  5.192***        
##                              (0.097)                  (0.372)         
##                                                                       
## female                      -1.404***                -1.971***        
##                              (0.149)                  (0.562)         
##                                                                       
## sector                      1.963***                  1.253***        
##                              (0.152)                  (0.306)         
##                                                                       
## Constant                    12.521***                13.128***        
##                              (0.131)                  (0.348)         
##                                                                       
## ----------------------------------------------------------------------
## Observations                  7,185                     160           
## R2                            0.160                    0.675          
## Adjusted R2                   0.159                    0.668          
## Residual Std. Error     6.307 (df = 7181)         1.796 (df = 156)    
## F Statistic         454.392*** (df = 3; 7181) 107.779*** (df = 3; 156)
## ======================================================================
## Note:                                      *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01
```
]


---
## ¿Cuál es el efecto "verdadero"?

![](taller_multinivel_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;


---
class: roja, bottom, right

# Descomposición de varianza

---
## Descomposición de la varianza

- varianza Nivel 1: dentro o "within", en relación al promedio individual

- varianza Nivel 2: entre o "between", en relación al promedio de los grupos
  
- varianza Nivel `\(j\)` ...


---
## Varianzas

.medium[

```r
 ggplot(merged, 
        aes(x=mathach, colour=id_data)) + 
        geom_density() + theme(text = element_text(size = 20))
```

![](taller_multinivel_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;
]

---
# Descomposición de la varianza

.pull-left[
![:scale 100%](https://multinivel.netlify.app/docpres/03_jerarquicos/images/withinbetween2.png)]

.pull-right[
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
`$$var_{tot}=var_{dentro}+var_{entre}$$`
]

---
# Descomposición de varianza y predictores 

![](https://multinivel.netlify.app/docpres/03_jerarquicos/images/var_pred.png)


---
class: inverse, middle, center

# **Correlación intra-clase (ICC)**

## _Proporción de la varianza de la variable dependiente que corresponde a unidades de nivel 2_


---
class: roja, middle, right

# Estimación modelo multinivel

### librería **lme4** de **R**
### Componentes de la varianza

### Efectos fijos y aleatorios

---
# Pasos (usuales) en la estimación multinivel
 
0.  Modelo nulo (descomposición de varianza e ICC)

1.  Modelo con variables individuales

2.  Modelo con variables contextuales

3.  Modelo con variables individuales y contextuales

4.  Modelo con pendiente (individual) aleatoria

5.  Modelo con variables individuales, contextuales e interacción entre
    niveles (cross-level interaction)
---
## 0.Modelo nulo

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_0.JPG)

---
## 1.Modelo con variable independiente individual

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_1.JPG)

---
## 2.Modelo con variable independiente grupal

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_2.JPG)

---
## 3.Modelo con variable independiente individual y grupal

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_3.JPG)

---
## 4.Modelo con pendiente aleatoria

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_4.JPG)

---
## 4.Modelo con pendiente aleatoria

![image](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/random2.jpg)

---
## 5.Modelo con interacción entre niveles

![:scale 65%](https://multinivel.netlify.app/docpres/04_icc&amp;ranef/images/model_5.JPG)

.medium[
"La relación entre X e Y varía entre contextos, y esta variación se asocia a una característica del contexto"

*Ej*: la influencia del nivel socioeconómico en rendimiento en lenguaje es moderada por la presencia de bibliotecas en las escuelas]


  
---
## Notas del modelo nulo e ICC

-   Descomposición de la varianza en modelo nulo=
    `\(Var\ y=\tau_{00} + \sigma^2\)` = grupal + individual

-   Correlación intra-clase = ICC =
    `\(\rho=\frac{\tau_{00}}{\tau_{00}+\sigma^2}\)`

-   Una ICC **baja** indica poca variabilidad de la
    variable dependiente entre unidades de nivel 2
      - _por lo tanto_, menores posibilidades de dar cuenta (*explicar*) de esa varianza con
    predictores de nivel 2.

---
# Estimación multinivel en `R`

### librería lme4, función `lmer` (linear mixed effects)

-   forma general:

    -   `objeto &lt;- lmer (depvar ~ predictor_1 + predictor_2 + predictor_n + (1 | cluster), data=data)`

    -   el objeto contiene la información de la estimación; para ver un
        resumen, `summary(objeto)`, y de manera más presentable,
        `screenreg(objeto)`


---
class: roja bottom right

# Práctica B: Estimación multinivel en R

##[link](https://multinivel.netlify.app/practicas/b_iccranef/b_icc-ranef.html)

---
class: middle center

# ¡gracias!

Más información en sitio del curso electivo FACSO: [https://multinivel.netlify.app/](https://multinivel.netlify.app/)

---
class: inverse bottom right

![:scale 20%](https://multinivel.netlify.com/../images/hex_eic2.png)

# Taller estimación multinivel

Juan Carlos Castillo - [jc-castillo.com](http://jc-castillo.com/)

Enero 2021



    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="https://multinivel.netlify.com/docpres/xaringan_custom/macros.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<style>
.logo {
  background-image: url(logocoes.png);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  top: 0.5em;
  right: 1em;
  width: 200px;
  height: 460px;
  z-index: 2;
}
</style>

<script>
document
  .querySelectorAll(
    '.remark-slide-content' +
    ':not(.title-slide)' +
    // add additional classes to exclude here, e.g.
    // ':not(.inverse)' +
    ':not(.hide-logo)'
  )
  .forEach(el => {
    el.innerHTML += '<div class="logo"></div>';
  });
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
